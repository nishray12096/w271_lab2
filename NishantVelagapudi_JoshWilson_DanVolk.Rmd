---
title: "NishantVelagapudi_JoshWilson_DanVolk"
author: "Nishant Velagapudi, Josh Wilson, Dan Volk"
date: "February 15, 2018"
output: pdf_document
---

```{r Chunk Settings, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in Data

```{r Data And Package Load, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

pkg <- c('car', 'plyr', 'ggplot2', 'Hmisc', 'stargazer',
         'ggpubr', 'gridExtra', 'wesanderson', 'MASS')

lapply(pkg, require, character.only = T)

#change to your git location
#setwd("C:\Users\nishray\Documents\Berkeley_MIDS\W271\w271_lab2\DeHartSimplified.csv")

# data_c <- read.csv("C:\\Users\\nishray\\Documents\\Berkeley_MIDS\\W271\\w271_lab2\\DeHartSimplified.csv")
data_c <- read.csv("DeHartSimplified.csv", sep=",")
```


## Variable Dictionary
First, we define each of the variables within our dataset.
*id*: identifier of survey respondant
*studyday*:
*dayweek*: day of week (saturday == 6)
*numall*: number of alcoholic beverages consumed on that day
*nrel*: negative romantic relationship event
*prel*: positive romantic relatinship event
*negevent*: number & intensity of negative events in a day (0-3)
*posevent*: number & intensity of positive events in a day (0-3)
*gender*: male (1) female (2)
*rosn*: trait self-esteem
*age*:
*desired*: desire to drink each day, higher number corresponds to more desire
*state*: short-term self-esteem state

## Restricting Data to Mimic Example in Textbook

The data was collected over a 30 day period on the same subjects. This panel data structure is sidestepped by focusing on the first Saturday for all subjects. We therefore can run our typical analysies without having to treat the repeated measures inherent in the original study. When we have reduced the data set, we are left with 89 observations.
```{r Data Subset}
# Reducing data to first Saturday following the texbook methodology
df_sat <- data_c[data_c$dayweek == 6,]
```

# Variables
id:
studyday:
dayweek: day of week (saturday == 6)
numall: number of alcoholic beverages consumed on that day
nrel: negative romantic relationship event
prel: positive romantic relatinship event
negevent: number & intensity of negative events in a day (0-3)
posevent: number & intensity of positive events in a day (0-3)
gender: male (1) female (2)
rosn: trait self-esteem
age:
desired: desire to drink each day, higher number corresponds to more desire
state: short-term self-esteem state

## Missing Value Investigation
We start by investigating whether or not we are missing any datapoints:
```{r Missing Data}
# Missing Data Inspection
df_sat[which(complete.cases(df_sat) == F),]
```
In the full data set, there were missing values, albeit few and far between. The reduced data set has no missing values. This is a surprising result as the study design seems to incorporate self-reporting and these types of designs are often rife with meaningfully missing data.

## Univariate EDA
We next investigate and visualize individual variables.
```{r Univariate EDA}
#library(sos)
#findFn("describe")
# May be overdoing it
Hmisc::describe(df_sat, skew = T)

#par(mfrow=c(1,3))

#Variables of immediate interest: rosn = self-worth, nrel=negative relationship interactions, desired = desire to drink
#We see that Id identifies a single respondant: each respondant has 7 responses (one for each day of the week)
ggplot(data = df_sat, aes(x = numall)) + geom_histogram() + stat_bin(bins = 20)
ggplot(data = df_sat, aes(x = nrel)) + geom_histogram()
ggplot(data = df_sat, aes(x = desired)) + geom_histogram()
ggplot(data = df_sat, aes(x = rosn)) + geom_histogram()
ggplot(data = df_sat, aes(x = state)) + geom_histogram()
ggplot(data = df_sat, aes(x = age)) + geom_histogram()

#We see that Id identifies a single respondant: each respondant has 7 responses (one for each day of the week)
dplyr::count(data, id)

#We see a skewed response distribution by gender
dplyr::count(data, gender)
```
We see that the number of drinks variable is positively skewed, with half of the data being below 4 and a tail extending rightwards. There are two fairly prevalent spikes at 2 and 5, which also give the data a rather non-normal shape. We will take care to determine if outliers are unduly influencing any models developed. 

The Nrel variable has a large spike at zero suggesting that most people don't have negative romantic events on Saturday. However, this variable is relatively sparse and likely needs to be bucketed or even binarized.

The desire to drink variable is relatively bell-shaped which corresponds to intuition as one would expect a random sample to provide decent variability on drinking preferences.

The self worth variable is negatively skewed and has a large spike near the value of 3.5. This variable might also be prime for a transformation or bucketing.

The distribution of state seems to follow a similar pattern to the self worth variable, but applied to a different range.

The distribution of age is odd. There are practically no participants below 25 and very few above 40. This appears to be a purposely truncated selection method. Without further explanation, the generalizability of the study might be threatened.

The sample leans a bit towards women, with 56% of the particpants being women.

```{r}
# Plot of dependent variable vs poisson distribution
rel.freq <- table(df_sat$numall)/length(df_sat$numall)
rel.freq2 <- c(rel.freq, rep(0, times=7))
y <- 0:15
prob <- round(dpois(y, mean(df_sat$numall)), 4)
plot(y-0.1, prob, type="h", ylab="Probability", xlab="# of Drinks", main="Observed Data vs Poisson")
axis(side=1, at=seq(0,15,2))
lines(y+0.1, y=rel.freq2, type="h", col='red')
legend(17,0.25, c("Poisson", "Observed"), col=c('black','red'), lty=c('solid','solid'), bty='n')
```

The comparison between the simulated Poisson distribution with a mean equal to that of our sample appears to be a relatively good fit. This makes sense as the number of drinks consumed - our dependent variable - is a count variable. One concern is that the zero might be inflated and we will have to take care when we model this as a poisson. Generally, we believe the dependent variable lends itself to Poisson regression analysis.

```{r}
#bucket data
data['nrelBucket'] <- transform(data, group=cut(as.numeric(sub('[%]', '', nrel+.001)), 
    breaks=c(0,1, 2, 3, 4,5,6,7,8.1),
    labels=c('0-1', '1-2', '2-3', '3-4', '4-5', '5-6','6-7','7-8')))$group

data['rosnBucket'] <- transform(data, group=cut(as.numeric(sub('[%]', '', rosn)), 
    breaks=c(2,2.5, 3, 3.5, 4),
    labels=c('2-2.5', '2.5-3', '3-3.5', '3.5-4')))$group

data['desiredBucket'] <- transform(data, group=cut(as.numeric(sub('[%]', '', desired+.001)), 
    breaks=c(0,1, 2, 3, 4,5,6,7,8.1),
    labels=c('0-1', '1-2', '2-3', '3-4', '4-5', '5-6','6-7','7-8')))$group

length(data[data$nrel > 0, "nrel"])
#146 observations actually have nrel > 0. This could lead to an overestimation of the effect of nrel, especially in cases where nrel is very high.
data['HasNrel'] = data$nrel > 0

```


```{r}
#distribution of average desired by id
avgDrink <- data.frame(aggregate(desired ~ id, data, mean))
hist(avgDrink$desired)
```

```{r}
#we can see that the average desire to drink is also a normal distribution. This suggests that when we are looking at a desire to drink, we might want to consider what that person's "baseline" drinking is

#we can do this by taking a desire to drink as a distance from average desire to drink

data = merge(data, avgDrink, by="id")
data = rename(data, c('desired.y' = 'Id_MeanDrink', 'desired.x' = 'desired'))

data['desired_adj'] = data$desired - data$Id_MeanDrink
hist(data$desired_adj)

#this gives a normal distribution of desired
```


## Bivariate Analysis
We next look at investigating relationships between variables. First, we investigate how gender might vary with desire to drink and each of our identified explanatory variables of interest.

Josh: What's interesting here is that gender doesn't seem to matter much for any of these variables. It is important to note that some of the outliers are female, though. Especially, negative relationship events!

```{r}
#Split out three variables of interest by gender

biv_1 <- ggplot(data = df_sat, aes(factor(gender), rosn)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("Gender")       + ggtitle("Self-worth")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))

biv_2 <- ggplot(data = df_sat, aes(factor(gender), negevent)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("negevent")       + ggtitle("Neg. Rel. Events")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))

biv_3 <- ggplot(data = df_sat, aes(factor(gender), desired)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("desired")       + ggtitle("Drinking Desire")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))

ggarrange(biv_1, biv_2, biv_3, ncol=3, common.legend = TRUE, legend="bottom")
```

Our next series of plots asks a series of questions about relationships between each of our explanatory variables as well as our response variables.
```{r More EDA}

# Does  self esteem relate to desire to drink
ggplot(data = df, aes(x = rosn, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Self-Esteem") + ylab("Desire to Drink")

# Does Negative Romantic events relate to the desire to drink
ggplot(data = df, aes(x = nrel, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Negative Romantic Events") + ylab("Desire to Drink")

# Does Self-Esteem  relate to Total drink consumption
ggplot(data = df, aes(x = rosn, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Self-Esteem") + ylab("Total Drink Consumption")

# Looking At the Desire to Drink by Negative Events by Gender
ggplot(data = df, aes(x = rosn, y = desired, fill = as.factor(gender))) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Self-Esteem") + ylab("Desire to Drink")

# Does self-esteem vary by gender?
ggplot(data = df, aes(x = as.factor(gender), y = rosn)) + geom_boxplot(aes(fill=factor(gender))) + geom_jitter(width=0.1)

# Does self-esteem vary by age
ggplot(data = df, aes(x = age, y = rosn)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Age") + ylab("Self-Esteem")

# Numall by desire to drink, colorized by nrel binarized

ggplot(data = data, aes(x = desired, y = numall, colour = as.factor(HasNrel))) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")

# Numall by desire to drink, colorized by self esteem

ggplot(data = data, aes(x = desired, y = numall, color = rosn)) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")

# plot nrel versus rosn, colored by desire to drink
ggplot(data, aes(x=nrel, y=rosn,color=desired)) + geom_point()
```


We cross-tabulate our data to see how many observations fall into each bucket of negative relationship events, self worth values, and desire to drink values. 
```{r}
#volume and mean desire to drink in each bucket
dplyr::count(data, nrelBucket, rosnBucket, desiredBucket)

xtabs(desired ~ nrelBucket, aggregate(desired ~ nrelBucket, data, mean))
xtabs(desired ~ rosnBucket, aggregate(desired ~ rosnBucket, data, mean))

xtabs(desired ~ nrelBucket + rosnBucket, aggregate(desired ~ nrelBucket + rosnBucket, data, mean))
table(data$nrelBucket, data$rosnBucket)

```
We observe that desire to drink does appear to climb with negative relationship events, but there are so few observations with multiple negative relationship events that this finding cannot be taken at face value.

We focus on negative relationship events: splitting our desire to drink data into values where negative relationship events are more than zero or zero. Performing a wilcox rank-sum test informs us of whether or not there is a statistically significant average difference in desire to drink when the survey respondent has either no negative relationship events or some negative relationship events.
```{r}
data.frame(aggregate(desired ~ HasNrel, data, mean))
#little difference between 0 and nonzero here.
#test for significance of difference using wilcoxon rank sum test
#unaltered desired to drink - nonsignificant, closer to significance
wilcox.test(data[data$nrel > 0, "desired"], data[data$nrel == 0, "desired"])
#adjusted desire to drink - nonsignificant
wilcox.test(data[data$nrel > 0, "desired_adj"], data[data$nrel == 0, "desired_adj"])
```
We find that the difference is not significant: either when we test for desire to drink or desire to drink adjusted by the average desire to drink by respondant.

## Model Fitting

```{r}
mod <- glm(numall ~ nrel + rosn + nrel*rosn, family=poisson(link="log"), data=data)
summary(mod)
```



<<<<<<< HEAD
=======
# Numall by desire to drink, colorized by nrel binarized

ggplot(data = df, aes(x = desired, y = numall, colour = as.factor(nrel_bin))) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")


# Numall by desire to drink, colorized by self esteem

ggplot(data = df, aes(x = desired, y = numall, color = rosn)) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")


```
>>>>>>> f848ff1dec4fe60280975d7f559a5971c58014ad
