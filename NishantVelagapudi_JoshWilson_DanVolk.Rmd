---
title: "NishantVelagapudi_JoshWilson_DanVolk"
author: "Nishant Velagapudi, Josh Wilson, Dan Volk"
date: "February 15, 2018"
output: pdf_document
---

```{r Chunk Settings, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in Data
```{r Data And Package Load, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

# Packages used in analyses
pkg <- c('car', 'plyr', 'ggplot2', 'Hmisc', 'stargazer',
         'ggpubr', 'gridExtra', 'wesanderson', 'MASS')

# Vectorized package load
lapply(pkg, require, character.only = T)

# Data load
data_c <- read.csv("DeHartSimplified.csv", sep=",")
```


## Variable Dictionary
First, we define each of the variables within our dataset.
*id*: identifier of survey respondant
*studyday*:
*dayweek*: day of week (saturday == 6)
*numall*: number of alcoholic beverages consumed on that day
*nrel*: negative romantic relationship event
*prel*: positive romantic relatinship event
*negevent*: number & intensity of negative events in a day (0-3)
*posevent*: number & intensity of positive events in a day (0-3)
*gender*: male (1) female (2)
*rosn*: trait self-esteem
*age*:
*desired*: desire to drink each day, higher number corresponds to more desire
*state*: short-term self-esteem state

## Restricting Data to Mimic Example in Textbook/Testing assumption of independence

The data was collected over a 30 day period on the same subjects. This panel data structure is sidestepped by focusing on the first Saturday for all subjects. We therefore can run our typical analysies without having to treat the repeated measures inherent in the original study. When we have reduced the data set, we are left with 89 observations.
```{r}
# Test independence assumption
mod <- lm(desired ~ as.factor(id), data=data)
mean(summary(mod)$coefficients[,4]<0.05)
```

```{r Data Subset}
# Reducing data to first Saturday following the texbook methodology
df_sat <- data_c[data_c$dayweek == 6,]
```

## Missing Value Investigation
We start by investigating whether or not we are missing any datapoints:
```{r Missing Data}
# Missing Data Inspection
df_sat[which(complete.cases(df_sat) == F),]
```
In the full data set, there were missing values, albeit few and far between. The reduced data set has no missing values. This is a surprising result as the study design seems to incorporate self-reporting and these types of designs are often rife with meaningfully missing data.


## Univariate EDA
We next investigate and visualize individual variables.

Josh Note: I think the strategy for the univariate EDA is to show, pictorially, anything that is interesting distributionally and use the describe for the rest.

```{r Univariate EDA, message = F, warning = F}
# May be overdoing it
Hmisc::describe(df_sat, skew = T)[c('age', 'gender', 'negevent')]

# Histogram of Numall
hist_numall <- ggplot(data = df_sat, aes(x = numall)) + 
  geom_histogram() + stat_bin(colour = "black", fill ="blue") +
  ggtitle("Alcohol Consumption") +
  xlab('Number of Beverages Consumed') + theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5))

# Histogram of Nrel
hist_nrel <- ggplot(data = df_sat, aes(x = nrel)) + 
  geom_histogram() + stat_bin(colour = "black", fill ="blue") +
  ggtitle("Negative Romantic Events") +
  xlab('Number of Negative Romantic Events') + theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5))

# Histogram of State
hist_state <- ggplot(data = df_sat, aes(x = state)) + 
  geom_histogram() + stat_bin(colour = "black", fill ="blue") +
  ggtitle("Short-Term Self-Esteem") +
  xlab('Number of Negative Romantic Events') + theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5))

# Histogram  of Posevent
hist_pos <- ggplot(data = df_sat, aes(x = posevent)) + 
  geom_histogram() + stat_bin(colour = "black", fill ="blue") +
  ggtitle("Positive Events") +
  xlab('Positive Events Scale') + theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5))

ggarrange(hist_numall, hist_nrel, hist_state, hist_pos, ncol = 2, nrow = 2, common.legend = TRUE, legend = "bottom")
```
We see that the number of drinks variable is positively skewed, with half of the data being below 4 and a tail extending rightwards. There are two fairly prevalent spikes at 2 and 5, which also give the data a rather non-normal shape. We will take care to determine if outliers are unduly influencing any models developed. 

The Nrel variable has a large spike at zero suggesting that most people don't have negative romantic events on Saturday. However, this variable is relatively sparse and likely needs to be bucketed or even binarized.

The desire to drink variable is relatively bell-shaped which corresponds to intuition as one would expect a random sample to provide decent variability on drinking preferences.

The self worth variable is negatively skewed and has a large spike near the value of 3.5. This variable might also be prime for a transformation or bucketing.

The distribution of state seems to follow a similar pattern to the self worth variable, but applied to a different range.

The distribution of age is odd. There are practically no participants below 25 and very few above 40. This appears to be a purposely truncated selection method. Without further explanation, the generalizability of the study might be threatened.

The sample leans a bit towards women, with 56% of the particpants being women.

```{r}
# Plot of dependent variable vs poisson distribution
rel.freq <- table(factor(df_sat$numall, levels=0:21))/length(df_sat$numall)
y <- 0:21
prob <- round(dpois(y, mean(df_sat$numall)), 4)
plot(y-0.1, prob, type="h", ylab="Probability", xlab="# of Drinks", main="Observed Data vs Poisson")
axis(side=1, at=seq(0,22,2))
lines(y+0.1, y=rel.freq, type="h", col='red')
legend(17,0.25, c("Poisson", "Observed"), col=c('black','red'), lty=c('solid','solid'), bty='n')
```

The comparison between the simulated Poisson distribution with a mean equal to that of our sample appears to be a relatively good fit. This makes sense as the number of drinks consumed - our dependent variable - is a count variable. One concern is that the zero might be inflated and we will have to take care when we model this as a poisson. Generally, we believe the dependent variable lends itself to Poisson regression analysis.

```{r Variable Binning}

# Binarizing Negative Romantic Relationships and Positive Romantic Relationships
df_sat['HasNrel'] <- ifelse(df_sat$nrel > 0, 1, 0)
df_sat['HasPrel'] <- ifelse(df_sat$prel > 0, 1, 0)

#bucket data
df_sat['nrelBucket'] <- transform(df_sat, group=cut(as.numeric(sub('[%]', '', nrel+.001)), 
    breaks=c(0,1, 2, 3, 4,5,6,7,8.1),
    labels=c('0-1', '1-2', '2-3', '3-4', '4-5', '5-6','6-7','7-8')))$group

df_sat['rosnBucket'] <- transform(df_sat, group=cut(as.numeric(sub('[%]', '', rosn)), 
    breaks=c(2,2.5, 3, 3.5, 4),
    labels=c('2-2.5', '2.5-3', '3-3.5', '3.5-4')))$group

df_sat['desiredBucket'] <- transform(df_sat, group=cut(as.numeric(sub('[%]', '', desired+.001)), 
    breaks=c(0,1, 2, 3, 4,5,6,7,8.1),
    labels=c('0-1', '1-2', '2-3', '3-4', '4-5', '5-6','6-7','7-8')))$group
```

####INSERT VISUALIZATIONS OF BUCKETIZATIONS HERE, IF WANTED

## Bivariate Analysis
We next look at investigating relationships between variables. First, we investigate how gender might vary with desire to drink and each of our identified explanatory variables of interest.

Josh: What's interesting here is that gender doesn't seem to matter much for any of these variables. It is important to note that some of the outliers are female, though. Especially, negative relationship events!

```{r Boxplots}
#Split out three variables of interest by gender
bp_numall <- ggplot(data = df_sat, aes(factor(gender), numall)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width = 0.1, alpha = 0.6) + xlab("Gender") + ggtitle("Alcohol Consumption") +
         ylab("Drinks Consumed") +
         theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5)) +
         stat_summary(fun.y = mean, geom = "point", shape= 23, size = 3, fill = "red") +
         scale_x_discrete(labels = c("1" = "Male", "2" = "Female"))

bp_rosn <- ggplot(data = df_sat, aes(factor(gender), rosn)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width = 0.1, alpha = 0.6) + xlab("Gender") + ggtitle("Trait Self-Worth") +
         ylab("Trait Self-Worth") +  
         theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5)) +
         stat_summary(fun.y = mean, geom = "point", shape= 23, size = 3, fill = "red") +
         scale_x_discrete(labels = c("1" = "Male", "2" = "Female"))

bp_negev <- ggplot(data = df_sat, aes(factor(gender), negevent)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width = 0.1, alpha = 0.6) + xlab("Gender") + ggtitle("Negative Events") +
         ylab("Negative Events Experienced") +
         theme(plot.title=element_text(lineheight=1, face="bold", hjust = 0.5)) + 
         stat_summary(fun.y = mean, geom = "point", shape= 23, size = 3, fill = "red") +
         scale_x_discrete(labels = c("1" = "Male", "2" = "Female"))

ggarrange(bp_numall, bp_rosn, bp_negev, ncol=3, legend = 'none')
```

Not seen in these boxplots, but in others not show, we know that the drinking desire, state self-esteem, and positive events are all relatively similar across gender. Although, it does appear that females experience a higher number of positive events (there are more outliers towards the top end of the scale).



Our next series of plots asks a series of questions about relationships between each of our explanatory variables as well as our response variables.
```{r More EDA}

# Bivariate Relationships with numall

# Desire to drink and conumption
# Nonlinear and it looks like once desire gets to 4.5, there is a linear trend upwards 
# no transformations seem to address this well. binning seems like a possibility.
ggplot(data = df_sat, aes(x = desired, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Desired") + ylab("Total Alcoholic Consumption")

# Does Short term elf-Esteem  relate to Total drink consumptio
# Looks  interesting, but non-linrea, lowest self-esteem associated with high alcoholic beverage consumption
ggplot(data = df_sat, aes(x = state, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("State") + ylab("Total Drink Consumption")

# posevent and total drink conumption
ggplot(data = df_sat, aes(x = posevent, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("posevent") + ylab("Total Drink Consumption") + geom_jitter(width = 0.1)

# What is the relationship between positive events and prel
ggplot(data = df_sat, aes(x = posevent, y = prel)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("posevent") + ylab("prel") + geom_jitter(width = 0.1)


# What is the relationship between negevents and nrel
ggplot(data = df_sat, aes(x = negevent, y = nrel)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("negevent") + ylab("nrel") + geom_jitter(width = 0.1)

# Does Positive events relate to the desire to drink
ggplot(data = df_sat, aes(x = posevent, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Positive Events") + ylab("Desire to Drink")



## Working through these

# Does self-esteem vary by age
ggplot(data = df_sat, aes(x = age, y = rosn)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Age") + ylab("Self-Esteem")

# Numall by desire to drink, colorized by nrel binarized

ggplot(data = df_sat, aes(x = desired, y = numall, colour = as.factor(HasNrel))) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")


ggplot(data = df_sat, aes(x = desired, y = numall, colour = state)) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")


# Numall by desire to drink, colorized by self esteem

ggplot(data = df_sat, aes(x = desired, y = numall, color = rosn)) + 
  geom_point() + geom_smooth() + xlab("Desire to Drink") +
  ylab("Total Drink Consumption")

# Desire and Consumption with Gender
ggplot(data = df_sat, aes(x = desired, y = numall, colour = age)) + 
  geom_point() + geom_smooth() + xlab("Total Drink Consumption") +
  ylab("Desire to Drink")


# Age and Total Drink Consumption looks pretty flat
ggplot(data = df_sat, aes(x = age, y = numall, colour = as.factor(gender))) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Age") + ylab("Total Drink Consumption")

```


We cross-tabulate our data to see how many observations fall into each bucket of negative relationship events, self worth values, and desire to drink values. 
```{r}
#volume and mean desire to drink in each bucket
dplyr::count(data, nrelBucket, rosnBucket, desiredBucket)

xtabs(desired ~ nrelBucket, aggregate(desired ~ nrelBucket, data, mean))
xtabs(desired ~ rosnBucket, aggregate(desired ~ rosnBucket, data, mean))

xtabs(desired ~ nrelBucket + rosnBucket, aggregate(desired ~ nrelBucket + rosnBucket, data, mean))
table(data$nrelBucket, data$rosnBucket)

```
We observe that desire to drink does appear to climb with negative relationship events, but there are so few observations with multiple negative relationship events that this finding cannot be taken at face value.

## Model Fitting

We first compare a Poisson family model to a simple linear regression predicting drinks consumed.

```{r}
All_poisson <- glm(numall ~ nrel + rosn + nrel*rosn + desired + age + gender, family=poisson(link="log"), data=df_sat)

All_lm <- lm(numall ~ nrel + rosn + nrel*rosn + desired + age + gender, data=df_sat)

stargazer(All_poisson, All_lm, type="text")
AIC(All_lm)
```
We can see that the Poisson model has a better AIC: in tandem with the EDA performed comparing a simulated poisson distribution with the observations, this result leads us to use Poisson family models in hypothesis testing.

Here, we set up forwards and backwards stepwise selection of variables for inclusion in the model.

```{r}
step_columns <- df_sat[,] 

step_columns <- step_columns[complete.cases(step_columns),]

emptyMod <- glm(numall ~ 1, family=poisson(link="log"), data=step_columns)
fullMod <- glm(numall ~ ., family=poisson(link="log"), data=step_columns)

forw.sel <- step(object = emptyMod, scope = list(upper = fullMod), direction = "forward", k = log (nrow (step_columns)), trace = TRUE)

back.sel <- step(object = fullMod, scope = list(lower = emptyMod), direction = "backward", k = log(nrow(step_columns)), trace = TRUE)

```

We do not feel comfortable using the "desired" variable in predicting number of drinks consumed. We feel that the desire to drink variable is essentially a proxy for what we are trying to study, and including it drowns out the effects of other variables. 

We thus manually specify the next model:
```{r}
Poisson_V2 <- glm(numall ~ HasNrel + rosn + HasNrel:rosn + HasPrel + posevent + negevent + state, family=poisson(link="log"), data=df_sat)
summary(Poisson_V2)

plot(Poisson_V2)
100*(exp(Poisson_V2$coefficients)-1)
Anova(Poisson_V2)
```
We see high leverage residuals in this model, and will thus remove them prior to inference. The following stargazer compares coefficients before and after removing these outliers.

```{r}
Poisson_V2_prune <- glm(numall ~ HasNrel + rosn + HasNrel:rosn + prel + posevent + negevent + state, family=poisson(link="log"), data=df_sat[!(rownames(df_sat) %in% c(425,322,451)),])
summary(Poisson_V2_prune)

plot(Poisson_V2_prune)
exp(summary(Poisson_V2_prune)$coefficients[,1])
Anova(Poisson_V2_prune)

stargazer(Poisson_V2_prune, Poisson_V2, type="text")

```


## Appendix

1.
```{r Extra Boxplots}
biv_1 <- ggplot(data = df_sat, aes(factor(gender), posevent)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("Gender")       + ggtitle("Positive Events")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))

biv_2 <- ggplot(data = df_sat, aes(factor(gender), state)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("Gender")       + ggtitle("Self-Esteem State")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))

biv_3 <- ggplot(data = df_sat, aes(factor(gender), desired)) + geom_boxplot(aes(fill=factor(gender))) +
         geom_jitter(width=0.1) + xlab("desired")       + ggtitle("Drinking Desire")      +
         theme(plot.title=element_text(lineheight=1, face="bold"))


ggarrange(biv_1, biv_2, biv_3, ncol=3, common.legend = TRUE, legend = "bottom")
```

```{r Direct Look}
drk_x_hasnrel <- ggplot(data = df_sat, aes(x = as.factor(HasNrel), y = numall)) + geom_boxplot()
drk_x_hasnrel
```

2.
```{r Discarded Bivariate}


# Trait Self-Esteem and Total Drink Consumption looks pretty flat
# There are several outliers towards the far left, but only one seems problematic
ggplot(data = df_sat, aes(x = rosn, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Trait Self-Esteem") + ylab("Total Drink Consumption")


# Age and Total Drink Consumption looks pretty flat
ggplot(data = df_sat, aes(x = age, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Age") + ylab("Total Drink Consumption")


# prel and Total Drink Consumption looks pretty flat
ggplot(data = df_sat, aes(x = prel, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("prel") + ylab("Total Drink Consumption") + geom_jitter(width = 0.1)


# negevent/posevent
ggplot(data = df_sat, aes(x = negevent/posevent, y = numall)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Negative Romantic Events") + ylab("Desire to Drink")

# Whats the relationshiops between positive events and negative events
ggplot(data = df_sat, aes(x = posevent, y = negevent)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("posevent") + ylab("neg event") + geom_jitter(width = 0.1)


# Does  self esteem relate to desire to drink
ggplot(data = df_sat, aes(x = rosn, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Self-Esteem") + ylab("Desire to Drink")


ggplot(data = df_sat, aes(x = state, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Self-Esteem") + ylab("Desire to Drink")


# Does Negative Romantic events relate to the desire to drink
ggplot(data = df_sat, aes(x = negevent, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Negative Romantic Events") + ylab("Desire to Drink")

# Does Negative Romantic events relate to the desire to drink
ggplot(data = df_sat, aes(x = prel, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Positive Romantic Events") + ylab("Desire to Drink")

# Does Negative Romantic events relate to the desire to drink
ggplot(data = df_sat, aes(x = negevent/posevent, y = desired)) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Ratio Neg/Pos Events") + ylab("Desire to Drink")


# Looking At the Desire to Drink by Negative Events by Gender
ggplot(data = df_sat, aes(x = rosn, y = desired, fill = as.factor(gender))) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Trait Self-Esteem") + ylab("Desire to Drink")


# Looking At the Desire to Drink by Negative Events by Gender
ggplot(data = df_sat, aes(x = rosn, y = numall, fill = as.factor(gender))) + geom_point(alpha = 0.3) +
  geom_smooth() + xlab("Trait Self-Esteem") + ylab("Total Drink Consumption")

```
3. 
Adjusting desire to drink by mean desire

```{r}
#we can see that the average desire to drink is also a normal distribution. This suggests that when we are looking at a desire to drink, we might want to consider what that person's "baseline" drinking is

#we can do this by taking a desire to drink as a distance from average desire to drink

df_sat = merge(df_sat, avgDrink, by="id")
df_sat = rename(df_sat, c('desired.y' = 'Id_MeanDrink', 'desired.x' = 'desired'))

df_sat['desired_adj'] = df_sat$desired - df_sat$Id_MeanDrink
hist(df_sat$desired_adj)

#this gives a normal distribution of desired
```

4. Testing significance of mean drink consumed delta between those with negative relationship events and those without

Performing a wilcox rank-sum test informs us of whether or not there is a statistically significant average difference in desire to drink when the survey respondent has either no negative relationship events or some negative relationship events.
```{r}
data.frame(aggregate(desired ~ HasNrel, df_sat, mean))
#little difference between 0 and nonzero here.
#test for significance of difference using wilcoxon rank sum test
#unaltered desired to drink - nonsignificant, closer to significance
wilcox.test(df_sat[df_sat$nrel > 0, "numall"], df_sat[df_sat$nrel == 0, "numall"])
#adjusted desire to drink - nonsignificant
wilcox.test(df_sat[df_sat$nrel > 0, "numall"], df_sat[df_sat$nrel == 0, "numall"])
```
We find that the difference is not significant: either when we test for desire to drink or desire to drink adjusted by the average desire to drink by respondant.

5. Forwards and backwards selection


